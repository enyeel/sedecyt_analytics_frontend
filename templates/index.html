<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Index con Dashboards</title>
  <link rel="stylesheet" href="../static/css/global.css">
  <link rel="stylesheet" href="../static/css/dashboard.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center;">
      <img src="../static/imgs/logo-sedec.png" alt="Logo de la compañía">
    </div>
    <div class="filter-bar">
      <label for="start-date">De:</label>
      <input type="date" id="start-date">
      <label for="end-date">A:</label>
      <input type="date" id="end-date">
      <button id="filter-btn">Filtrar</button>
    </div>
  </header>

  <div id="main-app-container" class="container"> 
    
    <div id="card-view" class="main-content">
      </div>

    <div id="detail-view" class="detail-view-container">
        
        <div id="category-list-panel" class="subreport-list-panel">
            <h3 id="category-panel-title">Categorías</h3> 
            <ul id="main-category-list">
                </ul>
            
            <button id="back-to-cards" class="help-btn volver-btn" onclick="toggleDashboardView(false)">
                ← Volver a Dashboards
            </button>
        </div>
        
        <div class="main-viewer-panel">
            
            <div id="subreport-card-view" class="subreport-cards main-content">
                </div>

            <div id="single-report-viewer" class="single-report-viewer" style="display:none;">
                <h3 id="report-viewer-title"></h3>
                <iframe id="main-dashboard-viewer" src="" title="Visualizador de Reporte"></iframe>
                <button class="help-btn" id="back-to-subcards-btn" onclick="showSubreportCards()">← Ver todos los reportes</button>
            </div>
        </div>
    </div>
  </div>

  <script type="module">
    // IMPORTANTE: Asegúrate de tener este archivo en static/js/dashboardData.js
    import { DASHBOARDS_DATA } from '../static/js/dashboardData.js'; 

    let currentActiveCardId = null; 

    /**
     * Muestra/Oculta la vista de detalle (State 2/3 vs State 1).
     */
    function toggleDashboardView(showDetail) {
        const appContainer = document.getElementById('main-app-container');
        const backBtn = document.getElementById('back-to-cards');
        
        if (showDetail) {
            appContainer.classList.add('show-detail');
            backBtn.style.display = 'block';
        } else {
            // Vuelve al State 1 (Vista de Tarjetas de Inicio)
            appContainer.classList.remove('show-detail');
            backBtn.style.display = 'none';
            currentActiveCardId = null; 
            
            // Limpiar resaltado
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active-card'));
            document.querySelectorAll('#main-category-list .report-item').forEach(item => item.classList.remove('active'));
        }
    }
    
    /**
     * Función central para seleccionar una categoría (Desde tarjeta o desde sidebar).
     */
    function selectCategory(dashboardId) {
        const data = DASHBOARDS_DATA.find(d => d.id === dashboardId);
        if (!data) return;

        // Activar la vista de detalle si no lo está
        toggleDashboardView(true);
        currentActiveCardId = dashboardId;

        // 1. Resaltar la tarjeta activa en la vista inicial (si aún no ha desaparecido)
        document.querySelectorAll('#card-view .card').forEach(c => c.classList.remove('active-card'));
        const activeCard = document.querySelector(`#card-view .card[data-dashboard-id="${dashboardId}"]`);
        if(activeCard) activeCard.classList.add('active-card');

        // 2. Resaltar la categoría activa en el panel lateral
        document.querySelectorAll('#main-category-list .report-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`#main-category-list .report-item[data-dashboard-id="${dashboardId}"]`).classList.add('active');

        // 3. Renderizar las tarjetas de sub-reportes (State 2)
        renderSubreportCards(data);
        
        // 4. Asegurar que la vista de tarjetas esté visible
        showSubreportCards();
    }


    /**
     * Dibuja los sub-reportes como tarjetas (State 2).
     */
    function renderSubreportCards(data) {
        const cardView = document.getElementById('subreport-card-view');
        cardView.innerHTML = '';
        
        if (!data || !data.subreports || data.subreports.length === 0) {
            cardView.innerHTML = `<p style="text-align:center; padding: 40px;">No hay sub-reportes disponibles para ${data.titulo}.</p>`;
            return;
        }

        data.subreports.forEach(report => {
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.reportUrl = report.url;
            card.dataset.reportName = report.nombre;
            card.innerHTML = `
                <img src="${data.imagen}" alt="Reporte ${report.nombre}">
                <h3>${report.nombre}</h3>
                <p>Ver reporte detallado.</p>
            `;
            // Al hacer clic en un sub-reporte, lo mostramos en grande (State 3)
            card.addEventListener('click', showSingleReport);
            cardView.appendChild(card);
        });
    }
    
    /**
     * Muestra el sub-reporte seleccionado en grande (State 3).
     */
    function showSingleReport(e) {
        const card = e.currentTarget;
        const url = card.dataset.reportUrl;
        const name = card.dataset.reportName;
        const categoryTitle = DASHBOARDS_DATA.find(d => d.id === currentActiveCardId).titulo;

        document.getElementById('report-viewer-title').textContent = `${categoryTitle} - ${name}`;
        document.getElementById('main-dashboard-viewer').src = url;
        
        // Esconder tarjetas y mostrar visor
        document.getElementById('subreport-card-view').style.display = 'none';
        document.getElementById('single-report-viewer').style.display = 'block';

        // Actualizar el botón de volver dentro del visor (Regresa a State 2)
        const backButtonViewer = document.getElementById('back-to-subcards-btn');
        backButtonViewer.textContent = `← Ver todos los reportes de ${categoryTitle}`;
    }

    /**
     * Vuelve a mostrar la vista de tarjetas de sub-reportes (State 2).
     */
    function showSubreportCards() {
        document.getElementById('subreport-card-view').style.display = 'grid';
        document.getElementById('single-report-viewer').style.display = 'none';
    }

    /**
     * Dibuja las tarjetas de CATEGORÍA y la lista lateral (Se ejecuta al cargar).
     */
    function renderDashboards() {
        const cardView = document.getElementById('card-view');
        const mainCategoryList = document.getElementById('main-category-list');
        cardView.innerHTML = '';
        mainCategoryList.innerHTML = '';

        DASHBOARDS_DATA.forEach(data => {
            // Renderizar Tarjetas de Categorías (State 1)
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.dashboardId = data.id;
            card.innerHTML = `
                <img src="${data.imagen}" alt="Dashboard ${data.id}">
                <h3>Dashboard ${data.id} (${data.titulo})</h3>
                <p>${data.descripcion}</p>
            `;
            card.addEventListener('click', (e) => selectCategory(data.id));
            cardView.appendChild(card);

            // Renderizar Lista Lateral de Categorías (Menú Persistente)
            const li = document.createElement('li');
            li.textContent = data.titulo;
            li.classList.add('report-item');
            li.dataset.dashboardId = data.id;
            li.addEventListener('click', (e) => selectCategory(data.id));
            mainCategoryList.appendChild(li);
        });
    }

    function filtrar() {
        const inicio = document.getElementById("start-date").value;
        const fin = document.getElementById("end-date").value;
        
        if(inicio && fin){
            alert(`Filtros aplicados: ${inicio} a ${fin}. Esta funcionalidad afectaría la URL de los reportes cargados.`);
        } else {
            alert("Selecciona ambas fechas para filtrar.");
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderDashboards();
        document.getElementById('filter-btn').addEventListener('click', filtrar);
        
        // Cerrar haciendo clic en el título del panel lateral
        document.getElementById('category-panel-title').addEventListener('click', () => {
            if (document.getElementById('main-app-container').classList.contains('show-detail')) {
                toggleDashboardView(false);
            }
        });
    });
  </script>
</body>