<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Index con Dashboards</title>
  <link rel="stylesheet" href="../static/css/global.css">
  <link rel="stylesheet" href="../static/css/dashboard.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center;">
      <img src="../static/imgs/logo-sedec.png" alt="Logo de la compañía">
    </div>
    <div class="filter-bar">
      <label for="start-date">De:</label>
      <input type="date" id="start-date">
      <label for="end-date">A:</label>
      <input type="date" id="end-date">
      <button id="filter-btn">Filtrar</button>
    </div>
  </header>

  <div id="main-app-container" class="container"> 
    
    <div id="card-view" class="main-content">
      </div>

    <div id="detail-view" class="detail-view-container">
        <div id="subreport-list" class="subreport-list-panel">
            <h3 id="subreport-title">Sub-Reportes</h3> 
            <ul id="report-list">
                </ul>
            
            <button id="back-to-cards" class="help-btn volver-btn" style="display:none;" onclick="toggleDashboardView(false)">
                ← Volver a Dashboards
            </button>
        </div>
        
        <div class="main-viewer-panel">
            <iframe id="main-dashboard-viewer" src="" title="Visualizador de Reporte"></iframe>
        </div>
    </div>
  </div>

  <script type="module">
    // IMPORTANTE: Asegúrate de tener este archivo en static/js/
    import { DASHBOARDS_DATA } from '../static/js/dashboardData.js'; 

    let currentActiveCardId = null; 

    function toggleDashboardView(showDetail) {
        const appContainer = document.getElementById('main-app-container');
        const backBtn = document.getElementById('back-to-cards');
        
        if (showDetail) {
            appContainer.classList.add('show-detail');
            backBtn.style.display = 'block';
        } else {
            appContainer.classList.remove('show-detail');
            backBtn.style.display = 'none';
            currentActiveCardId = null; 
            
            // Limpiar el resaltado de la tarjeta activa
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active-card'));
        }
    }
    
    function mostrarSubReports(e) {
        const card = e.currentTarget;
        const dashboardId = parseInt(card.dataset.dashboardId);
        
        // Lógica de TOGGLE en TARJETA
        if (currentActiveCardId === dashboardId) {
            toggleDashboardView(false); 
            return;
        }

        toggleDashboardView(true);
        currentActiveCardId = dashboardId;

        // Resaltar la tarjeta activa
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active-card'));
        card.classList.add('active-card');

        // Obtener datos y llenar la lista
        const data = DASHBOARDS_DATA.find(d => d.id === dashboardId);
        if (!data || !data.subreports || data.subreports.length === 0) {
            console.error("No se encontraron datos o sub-reportes.");
            document.getElementById('main-dashboard-viewer').src = "about:blank";
            document.getElementById('report-list').innerHTML = '';
            return;
        }
        
        const reportList = document.getElementById('report-list');
        const viewer = document.getElementById('main-dashboard-viewer');
        const subreportTitle = document.getElementById('subreport-title');

        subreportTitle.textContent = `${data.titulo} - Reportes`;
        reportList.innerHTML = ''; 
        
        data.subreports.forEach(report => {
            const li = document.createElement('li');
            li.textContent = report.nombre;
            li.classList.add('report-item');
            
            li.addEventListener('click', () => {
                document.querySelectorAll('#report-list .report-item').forEach(item => item.classList.remove('active'));
                li.classList.add('active'); 
                viewer.src = report.url; 
            });
            reportList.appendChild(li);
        });

        const firstReport = document.querySelector('#report-list .report-item');
        if (firstReport) {
            firstReport.click(); 
        }
    }

    function renderDashboards() {
        const cardView = document.getElementById('card-view');
        cardView.innerHTML = '';

        DASHBOARDS_DATA.forEach(data => {
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.dashboardId = data.id;
            card.innerHTML = `
                <img src="${data.imagen}" alt="Dashboard ${data.id}">
                <h3>Dashboard ${data.id} (${data.titulo})</h3>
                <p>${data.descripcion}</p>
            `;
            card.addEventListener('click', mostrarSubReports);
            cardView.appendChild(card);
        });
    }
    
    function filtrar() {
        const inicio = document.getElementById("start-date").value;
        const fin = document.getElementById("end-date").value;
        
        if(inicio && fin){
            alert(`Filtros aplicados: ${inicio} a ${fin}. Esta funcionalidad afectaría la URL de los reportes cargados.`);
        } else {
            alert("Selecciona ambas fechas para filtrar.");
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderDashboards();
        document.getElementById('filter-btn').addEventListener('click', filtrar);

        // LÓGICA: Cerrar al dar click en el título del panel lateral
        document.getElementById('subreport-title').addEventListener('click', () => {
            if (document.getElementById('main-app-container').classList.contains('show-detail')) {
                toggleDashboardView(false);
            }
        });
    });
  </script>
</body>
</html>